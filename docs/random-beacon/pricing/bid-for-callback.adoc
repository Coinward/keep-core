= Bid for callback

== Bids

=== Main bid
A _main bid_ is a request for a new beacon entry.
There can be only one _main bid_ per entry,
and each entry requires a _main bid_.

A _main bid_ includes a _bid value_
which must be paid to the beacon along with the bid,
and may optionally include a _callback address_
and/or custom _entry input_.

==== Callback bid
A _callback bid_ is a _main bid_
with the intent of having that entry be given as input
to the specified _callback_ as soon as it is created.

A _callback bid_ is required to specify the _callback address_,
and provide enough currency
to pay for the gas required for the callback.
Separating the gas payment from the entry bid
is necessary for the integrity of the bidding;
an expensive callback could leave little to no profit for the beacon
despite easily taking the highest-bidder position.

==== Entry input
A bid can provide custom _entry input_
consisting of the _parent entry_,
_group seed_, and _signing seed_.
If any component of the _entry input_ is not provided with the bid,
it will be automatically generated by the beacon.

The _entry input_ determines which group will produce the entry,
and which values the selected group will sign.
By choosing the _entry input_ appropriately,
the resulting entry can be manipulated almost arbitrarily
or protected from all but the most powerful and well-coordinated
attempts to influence it.

The default _entry input_ should be generated in a way
which is both inexpensive to calculate
and difficult to manipulate by any party.

==== Sufficient and insufficient bids
A bid whose _bid value_ is at least the current _entry price_
is _sufficient_ for generating a new entry
as soon as it becomes _eligible_.
A bid whose _value_ is less than the _entry price_ is _insufficient_.
An _insufficient_ bid requires a _support bid_
to become _eligible_ for generating a beacon entry,
and is likely to have a very low priority.

==== Bid expiration (optional)
If bids are made with an expiration time,
_insufficient_ bids can be removed from the bid pool
once the expiration time is reached,
and the _bid value_ refunded to the requester
after subtracting transaction fees.

_Sufficient_ bids are _eligible_ when created,
and cannot expire.

=== Support bid
Because crowdfunding can be externalized,
the beacon doesn't need to be concerned with the details
of on-chain assurance contracts.
A support bid can be defined as simply paying the difference
to increase the value of the highest-valued _insufficient_ bid
to the current _entry price_.

== Bid ordering
Favoring high bidders is a crucial element
of the plan to capture enough value to make the beacon profitable.
A higher rank in the bidding
makes the beacon faster and more reliable
in responding to the request.

=== Batches
Processing requests as they arrive would be complicated
and subject to extensive miner manipulation.
Instead, the requests are processed in _batches_.
Each _batch_ is the set of requests
that have been mined in the same block.
While miners can still choose which requests to include or exclude,
they cannot reorder transactions to frontrun the bidding
without losing transaction fees.

After a block has been mined,
the _batch_ of requests is ready for processing.
The requests are ordered by their _bid values_,
and added to the _pending requests_ from previous batches.

==== Pending requests
The _pending requests_ contains
all requests that have been made,
but haven't been _served_ with a new entry.

_Pending requests_ are arranged by the _batch_ they were received in,
and requests from the same _batch_ are sorted by their _bid values_.
The _pending requests_ can be thought of
as a map of lists:
`pending_requests[batch] -> list[request]`

==== Eligible requests
When a _batch of requests_ has been processed,
the requests _eligible_ for a new entry can be calculated.
The highest-ranked _pending request_
from each previous _batch_ with remaining unserved requests
is _eligible_ to receive a new entry.

A request is not _eligible_ to receive an entry
until all higher-ranked requests from the same _batch_
have been mined.

If any of the _pending requests_ is _insufficient_
and a _support bid_ is available,
the _support bid_ is applied to the _insufficient_ request
to make it _eligible_ for an entry.
If there are multiple _insufficient_ requests,
any available _support bids_
are applied in the order of their _bid values_,
prioritizing the highest.

==== Serving requests
Each group that can generate an entry for an _eligible request_
should proceed to do so.
Once a valid entry has been produced,
the corresponding request is _served_.
The members of the _signing group_ are rewarded for their contribution
(or punished if extremely late).
The request is removed from the pending requests,
making the next-highest ranking request of the same batch
eligible in the next block.

== Entry generation
New entries are generated by selecting a _signing group_
which then produces a threshold signature of the _signing input_.

The resulting signature is deterministic,
meaning that for one group and one input
there is one and only one possible output.
This means that the signature is determined
purely by the selection of the _signing group_ and the _input_,
and cannot be manipulated by the signers.
Even if the _signing group_ is controlled by an adversary,
they can only _front-run_ the beacon
by calculating values in advance.
Choosing the right input can make frontrunning infeasible.

=== Signing group selection
When an entry is produced,
a _signing group_ must be selected.
To ensure even distribution of work,
the group should be selected with pseudorandom sortition
from all active signing groups.

Due to the manipulateability requirement,
the sortition should depend only on the set of available groups
and the requester's input.

To ensure beacon integrity,
the sortition must use a _group seed_ provided by the requester.
If the group is selected only on the basis of the _parent entry_,
it is possible to manipulate bids to "capture" the beacon
to only ever produce signatures from one group,
controlled by the attacker.

Due to the requirements,
the signing group must be selected as
`signing_group = current_groups.choose(parent_entry, group_seed)`.

=== Signature generation
The selected _signing group_ produces the new entry
by creating a threshold BLS signature for the _signing input_.

To achieve manipulateability,
the _signing input_ must be entirely contained in the request.

If only the _parent entry_ is signed to produce the new entry,
any other entries using the same _signing group_ and _parent entry_
would result in the same entry.
A separate _signing seed_ is thus necessary.

This gives the signature as
`new_entry = signing_group.bls_sign(parent_entry, signing_seed)`
